---
title: 'O2SS0157：打开的动态字符串 .。。对于未转换 (错误) '
description: 介绍 Oracle SQL Server 迁移助手 (SSMA) 为何不在打开的 .。。FOR 语句。
author: nahk-ivanov
ms.prod: sql
ms.technology: ssma
ms.devlang: sql
ms.topic: reference
ms.date: 1/22/2020
ms.author: alexiva
ms.openlocfilehash: e0837a6ad93beffc04b478f2154914b209ec8e99
ms.sourcegitcommit: 33f0f190f962059826e002be165a2bef4f9e350c
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 01/30/2021
ms.locfileid: "99187914"
---
# <a name="o2ss0157-dynamic-string-for-openfor-not-converted-error"></a>O2SS0157：打开的动态字符串 .。。对于未转换 (错误) 

本文介绍 Oracle SQL Server 迁移助手 (SSMA) 为何不转换语句中的动态字符串 `OPEN ... FOR` 。

## <a name="background"></a>背景

`OPEN-FOR`语句实现与 cursor 变量关联的查询，并分配数据库资源来处理查询并识别结果集。 `CURSOR`是一种机制，通过该机制可以将名称分配给 `SELECT` 语句并操作该 SQL 语句内的信息。

为了 `OPEN ... FOR` 使用 SSMA 转换游标，首先需要在 SSMA 项目设置中设置参数。 有关相关项目设置的详细信息可在 [O2SS0094](o2ss0094.md) 错误消息一文中找到。

如果代码中有任何动态字符串，则 SSMA 工具将生成错误消息。

## <a name="example"></a>示例

请看下面的示例，你可能会在 Oracle 过程中找到：

```sql
DECLARE
    emp_refcur SYS_REFCURSOR;
BEGIN
    OPEN
        emp_refcur
    FOR
        'SELECT ename FROM emp';

    CLOSE emp_refcur;
END;
```

当你尝试在 SSMA 中转换上面的代码时，它将生成以下错误消息：

> O2SS0157：打开的动态字符串 .。。对于未转换

## <a name="possible-remedies"></a>可能的补救措施

更正动态字符串错误有两个可能的补救措施。

### <a name="first-approach"></a>第一种方法

从动态查询中删除单引号，使其成为静态查询并再次运行 SSMA。 下面是修改后的 Oracle 代码：

```sql
DECLARE
    emp_refcur SYS_REFCURSOR;
BEGIN
    OPEN
        emp_refcur
    FOR
        SELECT ename FROM emp;

    CLOSE emp_refcur;
END;
```

SSMA 将生成以下 Transact-sql 代码块：

```sql
BEGIN
    DECLARE
        @emp_refcur CURSOR

    SET @emp_refcur =
        CURSOR FOR
            SELECT EMP.ENAME
            FROM dbo.EMP

    OPEN @emp_refcur
END
```

### <a name="second-approach"></a>第二种方法

解决此错误的另一种方法是使用自然方法，并在 SQL Server，即直接从执行存储过程返回结果集。 与 Oracle 不同，此方法不需要使用任何游标作为输出参数。

为了说明这一点，让我们从第一种方法中获取修改后的代码：

```sql
DECLARE
    emp_refcur SYS_REFCURSOR;
BEGIN
    OPEN
        emp_refcur
    FOR
        SELECT ename FROM emp;

    CLOSE emp_refcur;
END;
```

SSMA 生成 SQL 代码，它将只返回一个游标，该游标会在表的列中具有值的引用 `ename` `emp` 。

SQL Server 存储过程旨在返回一个或多个结果集，而无需定义游标来处理结果。 通过在存储过程中执行用于 Oracle 游标的查询，可以在应用程序代码中处理结果集。

请考虑以下可模拟原始 Oracle 动态 SQL 示例的 Transact-sql 存储过程：

```sql
ALTER PROCEDURE dbo.P_CURSOR_PROC
AS
BEGIN
    DECLARE
        @query nvarchar(max)

    SET @query = 'SELECT ename FROM emp'

    EXECUTE sp_executesql @query
END
```

## <a name="related-conversion-messages"></a>相关转换消息

* [O2SS0094：无法将 CURSOR 转换为参数](o2ss0094.md)
* [O2SS0245：不支持返回语句中的游标转换](o2ss0245.md)
* O2SS0330：无法转换 CLOSE 语句
* O2SS0331：无法转换 FETCH 语句
